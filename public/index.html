<!DOCTYPE html>
<html>

<head>
	<script src="external/phaser.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="classes.js"></script>
</head>

<body>
	<script></script>
	<script>
		const screen_width = 700;
		const screen_height = 500;
		const tile_size = 16;
		const tile_scale = 0.065;
		const gameStarted = false;
		let current_sprites = [];
		let last_update_received = {};
		let player_count = 0;
		class WelcomeScene extends Phaser.Scene {
			constructor() {
				super({ key: "WelcomeScene" });
			}

			preload() { }

			create() {
				this.welcomeText = this.add.text(10, 10, "Click here to start!", {
					fontSize: "10px",
					fill: "#fff",
				});
				this.welcomeText.setInteractive();
			}
			update() {
				this.welcomeText.on("pointerdown", () => {
					this.welcomeText.destroy();
					game.scene.start("GameScene");
				});
			}
		}

		class GameScene extends Phaser.Scene {
			constructor() {
				super({ key: "GameScene" });
				this.activeObject;
				this.line;
			}

			preload() {
				this.load.spritesheet("icons", "assets/icons.png", {
					frameWidth: 23.5,
					frameHeight: 23.5,
				});
				this.load.image(
					"end_user",
					"assets/aws_assets/curated_list/end_user.png"
				);
				this.load.image(
					"computer",
					"assets/aws_assets/curated_list/compute.png"
				);
				this.load.image(
					"loadBalancer",
					"assets/aws_assets/curated_list/loadBalancer.png"
				);
				this.publishWebsite = this.add.text(10, 30, "Publish Website", {
					fontSize: "10px",
					fill: "#fff",
				});
				this.publishWebsite.setInteractive();
				this.incriseTraffic = this.add.text(10, 50, "Incrise Traffic", {
					fontSize: "10px",
					fill: "#fff",
				});
				this.incriseTraffic.setInteractive();
				this.trafficRateNumber = this.add.text(10, 70, 0, {
					fontSize: "10px",
					fill: "#fff",
				});
				this.activeObjectText = this.add.text(10, 10, "undefined", {
					fontSize: "10px",
					fill: "#fff",
				});
				this.scoreText = this.add.text(250, 10, "Score:", {
					fontSize: "10px",
					fill: "#fff",
				});
				this.scoreNumber = this.add.text(290, 10, String(0), {
					fontSize: "10px",
					fill: "#fff",
				});
			}

			create() {
				this.score = 1000
				this.generator = new Generator(this);
				this.createComputeGenerationButton();
				this.loadBalancer = new LoadBalancer(this);
				this.input.on("drag", (pointer, gameObject, dragX, dragY) => {
					gameObject.x = dragX;
					gameObject.y = dragY;
					if (
						(gameObject.connections.length > 0) &
						(gameObject != undefined)
					) {
						gameObject.connections.forEach(function (connection) {
							connection.sprite.clear()
							connection.sprite.lineBetween(
								dragX,
								dragY,
								connection.object.getCenter().x,
								connection.object.getCenter().y
							);
						})
					}
				}
				);
				this.input.on("pointerdown", (pointer, gameObject, dragX, dragY) => {
					if (gameObject[0] == undefined) {
						this.activeObject = undefined;
					}
				});
				this.publishWebsite.on("pointerdown", () => {
					this.publishWebsite.destroy()
					this.generator.startGeneration();
				})
				this.incriseTraffic.on("pointerdown", () => {
					this.generator.incriseTraffic()
				})
			}
			createComputeGenerationButton() {
				let button = this.add.sprite(600, 20, "icons");
				button.setFrame(15 * 15);
				button.setScale(3);
				button.setInteractive();
				this.computers = this.add.group(this);
				button.on("pointerup", () => {
					if (this.score >= 1000) {
						this.computers.add(new Computer(this));
						this.score -= 1000
					}

				});
			}
			update() {
				if (this.activeObject) {
					this.activeObjectText.setText(String(this.activeObject.id));
				} else {
					this.activeObjectText.setText("No active Object");
				}
				if ((this.activeObject === undefined | this.activeObject instanceof Generator) & (this.oldActiveObject instanceof MachineWithComputing)) {
					this.oldActiveObject.deleteShowCpu();
				}
				if (this.activeObject instanceof MachineWithComputing) {
					if (
						!(this.oldActiveObject == this.activeObject) &
						(this.oldActiveObject instanceof MachineWithComputing)
					) {
						this.oldActiveObject.deleteShowCpu();
					}
					if (!this.activeObject.chart) {
						this.activeObject.showCpu();
					}
				}
				if (this.generator.connections.length > 0) {
					this.generator.tryToSend();
				}

				this.loadBalancer.processPackets();
				this.computers.children.entries.forEach((computer) => {
					computer.processPackets();
				});
				this.scoreNumber.setText(String(this.score))
				this.trafficRateNumber.setText(String(this.generator.trafficRate))
				this.oldActiveObject = this.activeObject;
			}
		}

		const config = {
			type: Phaser.AUTO,
			width: screen_width,
			height: screen_height,
			backgroundColor: "#9b9b9b",
			scene: [WelcomeScene, GameScene],
		};
		var game = new Phaser.Game(config);
		var self;


	</script>
	<div id="chart-wrapper" class="chart" style="height: 170px; width: 350px; background-color: white">
		<canvas id="chart"></canvas>
	</div>
</body>

</html>

<div class="cwdb-chart-container-background cwdb-widget-polaris cwdb-widget-polaris-border-radius"></div>